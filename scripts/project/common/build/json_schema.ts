import FS from "node:fs";
import { Type } from "typebox";

import { isNonEmptyString } from "@/scripts/common/strings";

import { type BuildContext, missingPropertyErrorMessage } from "./context";

type TypeBoxObjectSchema<
  SchemaProperties extends Type.TProperties = Type.TProperties,
> = Type.TObject<SchemaProperties>;

/**
 * Writes the given `schema` (a JSON Schema object generated by TypeBox) to the
 * artifact file referenced in the given `ctx.`
 *
 * @requires `ctx.paths.artifactFile`
 * @throws {Error} If `ctx.paths.artifactFile` is not provided.
 * @throws {Error} If `ctx.paths.artifactFile` cannot be written to.
 *
 * @requires The process's working directory to be the package's root
 *  directory. Use `assertCwdIsPackageRootDir` from
 *  "@/scripts/common/packages" to assert this invariant before calling
 *  this function.
 */
export async function buildJsonSchema(
  schema: TypeBoxObjectSchema,
  ctx: BuildContext
) {
  if (!isNonEmptyString(ctx.paths.artifactFile)) {
    throw new Error(missingPropertyErrorMessage("ctx.paths.artifactFile"));
  }

  const prettier = await import("prettier");
  const unformattedSchemaStr = JSON.stringify(schema);
  const schemaStr = await prettier.format(unformattedSchemaStr, {
    parser: "json",
  });

  FS.writeFileSync(ctx.paths.artifactFile, schemaStr, {
    encoding: "utf8",
    mode: 0o644, // rw-r--r--
    flag: "w",
  });
}
